<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: 'Inter', sans-serif; background: #0a0a0a; color: white; 
            height: 100dvh; display: flex; overflow: hidden; 
        }

        /* --- Sidebar & Overlay (FIXED) --- */
        #overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); /* Darker Background */
            z-index: 2999; /* High priority */
            backdrop-filter: blur(2px);
        }

        .sidebar {
            width: 280px; background: #111; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; 
            transition: transform 0.3s ease-in-out; 
            z-index: 3000; /* Above overlay */
            position: relative;
        }

        @media (max-width: 768px) {
            .sidebar { 
                position: fixed; left: 0; top: 0; height: 100%; width: 85%; max-width: 300px;
                transform: translateX(-100%); 
                box-shadow: 10px 0 30px rgba(0,0,0,0.9);
            }
            .sidebar.active { transform: translateX(0); }
        }

        .user-list { flex: 1; overflow-y: auto; margin-top: 20px; }
        .user-item { padding: 12px; background: #1a1a1a; margin-bottom: 8px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
        .user-name { display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .status-icon { font-size: 1.2rem; }

        /* Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; width: 100%; }
        
        .header { padding: 15px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .menu-btn { background: none; border: none; color: white; font-size: 1.8rem; display: none; cursor: pointer; }
        @media (max-width: 768px) { .menu-btn { display: block; } }

        .call-btn { background: #222; border: 1px solid #444; color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; margin-left: 10px; }
        .call-btn:hover { background: #007bff; border-color: #007bff; }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 16px; border-radius: 12px; max-width: 85%; line-height: 1.4; font-size: 1rem; }
        .my-msg { align-self: flex-end; background: #007bff; color: white; }
        .other-msg { align-self: flex-start; background: #222; border: 1px solid #333; }

        .input-area { padding: 15px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px; padding-bottom: env(safe-area-inset-bottom, 20px); }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #333; background: #222; color: white; font-size: 1rem; }
        #send-btn { background: #007bff; border: none; padding: 12px 20px; border-radius: 25px; font-weight: bold; }

        /* Zoom UI */
        #video-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 4000; display: none; flex-direction: column; }
        .video-grid { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; }
        video#remote-video { width: 100%; height: 100%; object-fit: contain; }
        video#local-video { position: absolute; bottom: 100px; right: 20px; width: 100px; height: 140px; background: #222; border: 1px solid #555; border-radius: 8px; object-fit: cover; z-index: 4001; }
        .video-controls { height: 80px; background: #111; display: flex; justify-content: center; align-items: center; gap: 30px; padding-bottom: env(safe-area-inset-bottom, 10px); }
        .ctrl-btn { background: #333; border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .btn-end { background: #ff4757; width: 60px; height: 60px; font-size: 1.5rem; }

        /* Call Alert */
        #call-alert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.95); padding: 20px; border-radius: 15px; border: 1px solid #007bff; display: none; z-index: 5000; text-align: center; width: 90%; max-width: 300px; }
    </style>
</head>
<body>

    <div id="overlay" onclick="closeSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <h2 style="color:#007bff; margin-top:0;">Machi Chat</h2>
        <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:20px;">
            <p style="margin:0; color:#888;">ID: <strong style="color:white;">{{ room }}</strong></p>
            <p style="margin:5px 0 0 0; color:#888;">Pass: <strong style="color:white;">{{ password }}</strong></p>
            <button onclick="copyLink()" style="width:100%; margin-top:10px; padding:8px; background:#007bff; border:none; border-radius:5px; color:white; font-weight:bold;">Copy Link</button>
        </div>
        <h3 style="color:#888;">Online</h3>
        <div class="user-list" id="user-list"></div>
        <a href="{{ url_for('logout') }}" style="margin-top:auto; text-align:center; color:#ff4757; text-decoration:none; font-weight:bold; padding:15px;">Logout</a>
    </div>

    <div class="chat-area">
        <div class="header">
            <button class="menu-btn" onclick="openSidebar()">‚ò∞</button>
            <div id="typing" style="color:#007bff; font-size:0.9rem;"></div>
            <div>
                <button class="call-btn" onclick="startCall('audio')">üìû</button>
                <button class="call-btn" onclick="startCall('video')">üìπ</button>
            </div>
        </div>

        <div id="chat-box"></div>

        <div class="input-area">
            <input type="text" id="msg" placeholder="Message..." autocomplete="off">
            <button id="send-btn" onclick="send()">‚û§</button>
        </div>
    </div>

    <div id="video-overlay">
        <div class="video-grid">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div class="video-controls">
            <button class="ctrl-btn" onclick="toggleMute()">üé§</button>
            <button class="ctrl-btn btn-end" onclick="endCall()">‚ùå</button>
            <button class="ctrl-btn" onclick="toggleVideo()">üì∑</button>
        </div>
    </div>

    <div id="call-alert">
        <h3 id="caller-name" style="margin-top:0;">Incoming...</h3>
        <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
            <button onclick="acceptCall()" style="background:#00e676; border:none; padding:10px 20px; border-radius:20px; font-weight:bold;">Accept</button>
            <button onclick="rejectCall()" style="background:#ff4757; color:white; border:none; padding:10px 20px; border-radius:20px; font-weight:bold;">Reject</button>
        </div>
    </div>

<script>
    // --- SIDEBAR LOGIC (FIXED) ---
    function openSidebar() {
        document.getElementById('sidebar').classList.add('active');
        document.getElementById('overlay').style.display = 'block';
    }
    
    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('overlay').style.display = 'none';
    }

    // --- OTHER LOGIC ---
    var socket = io();
    var room = "{{ room }}";
    var user = "{{ username }}";
    var localStream;
    var peer;
    var callActive = false;

    function copyLink() { navigator.clipboard.writeText("{{ share_link | safe }}").then(()=>alert('Copied!')); }

    socket.emit('join', {username: user, room: room});
    socket.on('update_users', data => {
        var list = document.getElementById('user-list');
        list.innerHTML = "";
        data.users.forEach(u => {
            var icon = u.status === 'audio' ? "üìû" : (u.status === 'video' ? "üìπ" : "");
            list.innerHTML += `<div class="user-item"><div class="user-name">üü¢ ${u.name}</div><div class="status-icon">${icon}</div></div>`;
        });
    });

    var input = document.getElementById('msg');
    input.addEventListener('keydown', e => { if(e.key === 'Enter') send(); });
    function send() {
        if(input.value.trim()){ socket.emit('send_message', {msg: input.value, user: user, room: room}); input.value = ''; }
    }
    socket.on('receive_message', data => {
        var box = document.getElementById('chat-box');
        var cls = (data.user === user) ? 'my-msg' : (data.user === 'System' ? 'system' : 'other-msg');
        box.innerHTML += `<div class="message ${cls}"><b>${data.user==='System'?'':data.user}</b> ${data.msg}</div>`;
        box.scrollTop = box.scrollHeight;
    });

    // --- CALL LOGIC WITH ERROR HANDLING ---
    function startCall(type) {
        if(callActive) return alert("Already on call!");
        navigator.mediaDevices.getUserMedia({video: type==='video', audio: true}).then(stream => {
            setupCallUI(stream, type);
            socket.emit('call_invite', {caller: user, room: room, type: type});
            socket.emit('update_status', {status: type, room: room});
            peer = new SimplePeer({
                initiator: true, trickl: false, stream: stream,
                config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
            });
            setupPeerEvents(peer);
        }).catch(e => {
            // ERROR HANDLING
            if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                alert("‚ö†Ô∏è ‡Æï‡Øá‡ÆÆ‡Æ∞‡Ææ ‡ÆÜ‡Æ©‡Øç ‡ÆÜ‡Æï‡Æ≤! \n\n‡Æï‡Ææ‡Æ∞‡Æ£‡ÆÆ‡Øç: ‡Æµ‡Øá‡Æ± ‡Æü‡Øá‡Æ™‡Øç (Tab) ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡ÆÜ‡Æ™‡Øç ‡Æï‡Øá‡ÆÆ‡Æ∞‡Ææ‡Æµ‡Øà ‡ÆØ‡ØÇ‡Æ∏‡Øç ‡Æ™‡Æ£‡Øç‡Æ£‡ØÅ‡Æ§‡ØÅ.\n\n‡Æ§‡ØÄ‡Æ∞‡Øç‡Æµ‡ØÅ: ‡Æ™‡Æ¥‡Øà‡ÆØ ‡Æü‡Øá‡Æ™‡Øç‡Æ™‡Øà ‡Æï‡Øç‡Æ≥‡Øã‡Æ∏‡Øç ‡Æ™‡Æ£‡Øç‡Æ£‡Æø‡Æü‡Øç‡Æü‡ØÅ ‡Æ∞‡ØÄ‡ÆÉ‡Æ™‡Øç‡Æ∞‡ØÜ‡Æ∑‡Øç ‡Æ™‡Æ£‡Øç‡Æ£‡ØÅ‡Æô‡Øç‡Æï.");
            } else {
                alert("Error: " + e.message);
            }
        });
    }

    socket.on('call_incoming', data => {
        if(data.caller === user || callActive) return;
        document.getElementById('caller-name').innerText = "üìû " + data.caller;
        document.getElementById('call-alert').style.display = 'block';
        window.incomingData = data;
    });

    function acceptCall() {
        document.getElementById('call-alert').style.display = 'none';
        var data = window.incomingData;
        navigator.mediaDevices.getUserMedia({video: data.type==='video', audio: true}).then(stream => {
            setupCallUI(stream, data.type);
            socket.emit('update_status', {status: data.type, room: room});
            peer = new SimplePeer({
                initiator: false, trickl: false, stream: stream,
                config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
            });
            setupPeerEvents(peer);
            peer.signal(data.signal);
        }).catch(e => alert("Error: " + e));
    }

    function setupCallUI(stream, type) {
        callActive = true;
        localStream = stream;
        document.getElementById('video-overlay').style.display = 'flex';
        document.getElementById('local-video').srcObject = stream;
        if(type === 'audio') {
            document.getElementById('local-video').style.opacity = '0';
            document.getElementById('remote-video').style.opacity = '0';
        } else {
            document.getElementById('local-video').style.opacity = '1';
            document.getElementById('remote-video').style.opacity = '1';
        }
    }

    function setupPeerEvents(p) {
        p.on('signal', data => socket.emit('signal_data', {signal: data, room: room}));
        p.on('stream', stream => {
            var video = document.getElementById('remote-video');
            video.srcObject = stream;
            video.play().catch(e => console.log("Auto-play blocked", e));
        });
    }

    socket.on('signal_received', data => { if(peer) peer.signal(data.signal); });

    function endCall() {
        if(peer) peer.destroy();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('video-overlay').style.display = 'none';
        socket.emit('update_status', {status: 'idle', room: room});
        callActive = false;
        window.location.reload();
    }
    
    function rejectCall() { document.getElementById('call-alert').style.display = 'none'; }
    function toggleMute() { localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; }
    function toggleVideo() { localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled; }
</script>
</body>
</html>